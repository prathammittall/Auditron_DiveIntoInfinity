<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lawgic AI - Legal Document Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f7f2e7 0%, #f3eee5 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .lawgic-scroll::-webkit-scrollbar {
      width: 8px;
      background: #e5d3b3;
    }

    .lawgic-scroll::-webkit-scrollbar-thumb {
      background: #251c1a;
      border-radius: 8px;
    }

    .lawgic-scroll::-webkit-scrollbar-thumb:hover {
      background: #3d2c28;
    }

    .message-user {
      background: linear-gradient(135deg, #251c1a 0%, #3d2c28 100%);
      color: #f3eee5;
      border-radius: 18px 18px 4px 18px;
      animation: slideInRight 0.3s ease-out;
    }

    .message-bot {
      background: linear-gradient(135deg, #e5d3b3 0%, #d4c2a1 100%);
      color: #251c1a;
      border-radius: 18px 18px 18px 4px;
      animation: slideInLeft 0.3s ease-out;
      border: 1px solid #bfa77a;
    }

    .message-loading {
      background: linear-gradient(135deg, #e5d3b3 0%, #d4c2a1 100%);
      color: #7c5a3a;
      border-radius: 18px 18px 18px 4px;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .gradient-border {
      background: linear-gradient(135deg, #bfa77a, #d4c2a1);
      padding: 2px;
      border-radius: 12px;
    }

    .gradient-border>div {
      background: #f3eee5;
      border-radius: 10px;
    }

    .upload-zone {
      background: linear-gradient(135deg, #18100e 0%, #2d1e1b 100%);
      border: 2px dashed #3d2c28;
      transition: all 0.3s ease;
    }

    .upload-zone:hover {
      border-color: #bfa77a;
      background: linear-gradient(135deg, #2d1e1b 0%, #3d2c28 100%);
    }

    .upload-zone.dragover {
      border-color: #bfa77a;
      background: linear-gradient(135deg, #3d2c28 0%, #4a332e 100%);
      transform: scale(1.02);
    }

    .typing-indicator::after {
      content: '';
      display: inline-block;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background-color: #7c5a3a;
      animation: typing 1.4s infinite;
    }

    .typing-indicator::before {
      content: '‚óè ‚óè ';
      color: #7c5a3a;
      animation: typing 1.4s infinite;
    }

    @keyframes typing {

      0%,
      60%,
      100% {
        opacity: 0;
      }

      30% {
        opacity: 1;
      }
    }

    .reference-chip {
      background: linear-gradient(135deg, #bfa77a 0%, #a08c6a 100%);
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      display: inline-block;
      margin: 2px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .reference-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .progress-container {
      background: linear-gradient(135deg, #3d2c28 0%, #4a332e 100%);
      border-radius: 12px;
      padding: 2px;
      overflow: hidden;
    }

    .progress-bar {
      background: linear-gradient(135deg, #bfa77a 0%, #d4c2a1 100%);
      height: 8px;
      border-radius: 10px;
      transition: width 0.5s ease-in-out;
      box-shadow: 0 2px 4px rgba(191, 167, 122, 0.3);
    }

    .floating-action {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #251c1a 0%, #3d2c28 100%);
      color: #f3eee5;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(37, 28, 26, 0.3);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .floating-action:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(37, 28, 26, 0.4);
    }

    .chat-input {
      background: #f9f6f1;
      border: 2px solid #e5d3b3;
      border-radius: 24px;
      padding: 12px 20px;
      transition: all 0.3s ease;
    }

    .chat-input:focus {
      outline: none;
      border-color: #bfa77a;
      box-shadow: 0 0 0 3px rgba(191, 167, 122, 0.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #bfa77a 0%, #a08c6a 100%);
      color: #251c1a;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #a08c6a 0%, #8f7850 100%);
      transform: scale(1.05);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #7c5a3a 0%, #6b4e34 100%);
      color: #f3eee5;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 12px;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #6b4e34 0%, #5a412c 100%);
      transform: translateY(-1px);
    }

    .mobile-menu {
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

    .mobile-menu.open {
      transform: translateX(0);
    }

    @media (max-width: 768px) {
      .floating-action {
        bottom: 80px;
      }
    }
  </style>
</head>

<body class="h-screen w-screen flex flex-col">
  <!-- Mobile Menu Button -->
  <div class="md:hidden fixed top-4 left-4 z-50">
    <button id="mobileMenuBtn"
      class="bg-gradient-to-r from-[#251c1a] to-[#3d2c28] text-[#f3eee5] p-3 rounded-lg shadow-lg">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
  </div>

  <!-- Mobile Sidebar Overlay -->
  <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

  <div class="flex flex-1 h-full w-full">
    <!-- Enhanced Sidebar -->
    <aside id="sidebar"
      class="mobile-menu md:translate-x-0 fixed md:relative z-50 md:z-auto flex flex-col w-80 bg-gradient-to-br from-[#251c1a] to-[#3d2c28] text-[#f3eee5] p-8 space-y-8 min-h-full shadow-2xl">
      <div class="flex justify-between items-center">
        <div class="text-3xl font-bold bg-gradient-to-r from-[#bfa77a] to-[#d4c2a1] bg-clip-text text-transparent">
          Lawgic AI
        </div>
        <button id="closeMobileMenu" class="md:hidden text-[#f3eee5]">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div>
        <div class="font-semibold text-xl mb-3 text-[#e5d3b3]">Document Upload</div>
        <div class="text-sm mb-4 text-[#b8a48c]">Upload PDF documents for intelligent legal analysis</div>

        <div id="uploadZone"
          class="upload-zone rounded-xl p-6 mb-4 flex flex-col items-center border-2 border-dashed border-[#3d2c28] cursor-pointer">
          <svg class="w-12 h-12 text-[#bfa77a] mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          <div class="mb-2 text-[#e5d3b3] font-medium">Drag and drop your PDF here</div>
          <div class="mb-3 text-xs text-[#b8a48c]">or click to browse files</div>
          <input type="file" id="pdfFile" accept="application/pdf" class="hidden" />
          <label for="pdfFile" id="fileLabel"
            class="inline-block px-6 py-2 bg-gradient-to-r from-[#bfa77a] to-[#a08c6a] text-[#251c1a] rounded-lg cursor-pointer font-medium hover:from-[#a08c6a] hover:to-[#8f7850] transition-all duration-200">
            Browse Files
          </label>
          <span id="fileName" class="mt-3 text-xs text-[#b8a48c] truncate w-full text-center"></span>
        </div>

        <button onclick="uploadPDF()" id="uploadBtn"
          class="w-full bg-gradient-to-r from-[#bfa77a] to-[#a08c6a] hover:from-[#a08c6a] hover:to-[#8f7850] text-[#251c1a] font-semibold py-3 rounded-lg transition-all duration-200 mb-4 shadow-lg">
          üöÄ Process Document
        </button>

        <div class="progress-container h-4 mb-3 hidden" id="progressBarContainer">
          <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
        </div>
        <p id="uploadStatus" class="text-sm text-[#e5d3b3] text-center"></p>
      </div>

      <!-- Quick Actions -->
      <div>
        <div class="font-semibold mb-3 text-lg text-[#e5d3b3]">Quick Actions</div>
        <div class="space-y-2">
          <button onclick="generateRegulatorySummary()" id="regulatorySummaryBtn"
            class="w-full btn-secondary disabled:opacity-50" disabled>
            üìã Regulatory Summary
          </button>
          <button onclick="clearChat()" class="w-full btn-secondary">
            üóëÔ∏è Clear Chat
          </button>
        </div>
      </div>

      <div class="mt-auto">
        <div class="font-semibold mb-3 text-lg text-[#e5d3b3]">Quick Guide</div>
        <div class="space-y-2">
          <div class="flex items-center text-sm text-[#b8a48c]">
            <span
              class="w-6 h-6 rounded-full bg-[#bfa77a] text-[#251c1a] flex items-center justify-center text-xs font-bold mr-3">1</span>
            Upload your legal document (PDF)
          </div>
          <div class="flex items-center text-sm text-[#b8a48c]">
            <span
              class="w-6 h-6 rounded-full bg-[#bfa77a] text-[#251c1a] flex items-center justify-center text-xs font-bold mr-3">2</span>
            Wait for AI processing to complete
          </div>
          <div class="flex items-center text-sm text-[#b8a48c]">
            <span
              class="w-6 h-6 rounded-full bg-[#bfa77a] text-[#251c1a] flex items-center justify-center text-xs font-bold mr-3">3</span>
            Ask questions and get insights
          </div>
        </div>

        <div class="mt-6 p-4 bg-[#18100e] rounded-lg border border-[#3d2c28]">
          <div class="text-xs text-[#b8a48c] leading-relaxed">
            <strong class="text-[#bfa77a]">Pro Tip:</strong> Ask specific questions about compliance, risks, key
            clauses, or regulatory requirements for best results.
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col h-full w-full">
      <!-- Header -->
      <header class="bg-gradient-to-r from-[#f3eee5] to-[#e5d3b3] border-b border-[#d4c2a1] px-6 py-4 shadow-sm">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
          <div class="ml-12 md:ml-0">
            <h1 class="text-2xl md:text-3xl font-bold text-[#251c1a] tracking-tight">Legal Document Analyzer</h1>
            <div class="text-[#7c5a3a] italic text-sm">Powered by Advanced AI ‚Ä¢ Think Law, Think Logic</div>
          </div>
          <div id="docInfo" class="text-right">
            <div id="docTitle" class="text-sm font-semibold text-[#251c1a]">No document loaded</div>
            <div id="topMetrics" class="text-xs text-[#7c5a3a]">Upload a PDF to begin</div>
          </div>
        </div>
      </header>

      <!-- Content Grid -->
      <div class="flex-1 p-4 md:p-6 overflow-hidden">
        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">

          <!-- PDF Viewer -->
          <div class="gradient-border h-full">
            <div class="h-full p-1">
              <div class="bg-white rounded-lg h-full shadow-inner overflow-hidden">
                <iframe id="pdfViewer" class="w-full h-full" src="" title="PDF Viewer" frameborder="0"></iframe>
                <div id="pdfPlaceholder"
                  class="h-full flex items-center justify-center text-[#7c5a3a] bg-gradient-to-br from-[#f7f2e7] to-[#f3eee5]">
                  <div class="text-center">
                    <svg class="w-24 h-24 mx-auto mb-4 text-[#bfa77a] opacity-50" fill="currentColor"
                      viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                        clip-rule="evenodd" />
                    </svg>
                    <div class="text-xl font-semibold mb-2">PDF Document Preview</div>
                    <div class="text-sm opacity-70">Upload a document to view it here</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat Interface -->
          <div class="gradient-border h-full">
            <div class="h-full p-4 flex flex-col">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-[#251c1a]">AI Assistant</h2>
                <div id="chatStatus" class="text-xs text-[#7c5a3a] flex items-center">
                  <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    
                </div>
              </div>

              <!-- Chat Messages -->
              <div id="chatMessages" class="flex-1 overflow-y-auto lawgic-scroll space-y-4 mb-4 pr-2">
                <div class="message-bot p-4 max-w-[85%]">
                  <div class="mb-2">
                    <strong>üß† Lawgic AI</strong>
                    <span class="text-xs opacity-70 ml-2">Ready to assist</span>
                  </div>
                  <div>
                    Hello! I'm your legal document analysis assistant. Upload a PDF document to get started, then ask me
                    questions about:
                    <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
                      <li>Compliance requirements and gaps</li>
                      <li>Risk assessment and mitigation</li>
                      <li>Key clauses and obligations</li>
                      <li>Regulatory alignment</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Chat Input -->
              <div class="flex items-center space-x-3">
                <input type="text" id="userQuestion" placeholder="Ask about compliance, risks, key clauses..."
                  class="flex-1 chat-input" disabled onkeypress="handleKeyPress(event)" />
                <button onclick="askQuestion()" id="askBtn"
                  class="btn-primary w-12 h-12 flex items-center justify-center disabled:opacity-50" disabled>
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                </button>
              </div>

              <!-- Suggested Questions -->
              <div id="suggestedQuestions" class="mt-3 hidden">
                <div class="text-xs text-[#7c5a3a] mb-2">Suggested questions:</div>
                <div class="flex flex-wrap gap-2">
                  <button onclick="askSuggested('What are the key compliance requirements in this document?')"
                    class="text-xs px-3 py-1 bg-[#e5d3b3] text-[#251c1a] rounded-full hover:bg-[#d4c2a1] transition-all duration-200">
                    Key compliance requirements
                  </button>
                  <button onclick="askSuggested('What are the main risks identified in this document?')"
                    class="text-xs px-3 py-1 bg-[#e5d3b3] text-[#251c1a] rounded-full hover:bg-[#d4c2a1] transition-all duration-200">
                    Main risks
                  </button>
                  <button onclick="askSuggested('Summarize the key obligations and responsibilities.')"
                    class="text-xs px-3 py-1 bg-[#e5d3b3] text-[#251c1a] rounded-full hover:bg-[#d4c2a1] transition-all duration-200">
                    Key obligations
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Floating Action Button (Mobile) -->
  <div class="floating-action md:hidden" onclick="toggleMobileMenu()">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
    </svg>
  </div>

  <script>
    // Global variables
    let currentTaskId = null;
    let isUploading = false;
    let isProcessing = false;

    // DOM elements
    const uploadZone = document.getElementById('uploadZone');
    const pdfFile = document.getElementById('pdfFile');
    const fileName = document.getElementById('fileName');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');
    const pdfViewer = document.getElementById('pdfViewer');
    const pdfPlaceholder = document.getElementById('pdfPlaceholder');
    const chatMessages = document.getElementById('chatMessages');
    const userQuestion = document.getElementById('userQuestion');
    const askBtn = document.getElementById('askBtn');
    const docTitle = document.getElementById('docTitle');
    const topMetrics = document.getElementById('topMetrics');
    const suggestedQuestions = document.getElementById('suggestedQuestions');
    const regulatorySummaryBtn = document.getElementById('regulatorySummaryBtn');
    const sidebar = document.getElementById('sidebar');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const closeMobileMenu = document.getElementById('closeMobileMenu');

    // Mobile menu functionality
    function toggleMobileMenu() {
      sidebar.classList.toggle('open');
      mobileOverlay.classList.toggle('hidden');
    }

    mobileMenuBtn?.addEventListener('click', toggleMobileMenu);
    closeMobileMenu?.addEventListener('click', toggleMobileMenu);
    mobileOverlay?.addEventListener('click', toggleMobileMenu);

    // File upload functionality
    pdfFile.addEventListener('change', showFileName);

    // Drag and drop functionality
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type === 'application/pdf') {
        pdfFile.files = files;
        showFileName();
      } else {
        showNotification('Please drop a valid PDF file.', 'error');
      }
    });

    uploadZone.addEventListener('click', () => {
      pdfFile.click();
    });

    function showFileName() {
      const file = pdfFile.files[0];
      if (file) {
        fileName.textContent = file.name;
        fileName.className = fileName.className.replace('text-[#b8a48c]', 'text-[#bfa77a]');
      }
    }

    async function uploadPDF() {
      const file = pdfFile.files[0];

      if (!file) {
        showNotification('Please select a PDF file first.', 'error');
        return;
      }

      if (file.size > 50 * 1024 * 1024) {
        showNotification('File size must be less than 50MB.', 'error');
        return;
      }

      if (isUploading) return;

      isUploading = true;
      uploadBtn.disabled = true;
      uploadBtn.textContent = '‚è≥ Processing...';

      const formData = new FormData();
      formData.append('pdf', file);

      try {
        progressBarContainer.classList.remove('hidden');
        updateProgress(0, 'Starting upload...');

        const response = await fetch('/upload-pdf/', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          currentTaskId = result.task_id;
          updateDocumentInfo(result.metadata);
          pdfViewer.src = result.pdf_url;
          pdfPlaceholder.style.display = 'none';
          pdfViewer.style.display = 'block';

          uploadStatus.textContent = result.status;
          uploadStatus.className = uploadStatus.className.replace('text-red-400', 'text-green-400');

          // Poll for progress
          pollProgress();

          showNotification('Document uploaded successfully! Processing...', 'success');
        } else {
          throw new Error(result.error || 'Upload failed');
        }
      } catch (error) {
        console.error('Upload error:', error);
        showNotification(`Upload failed: ${error.message}`, 'error');
        resetUploadUI();
      }
    }

    function pollProgress() {
      if (!currentTaskId) return;

      const pollInterval = setInterval(async () => {
        try {
          const response = await fetch(`/progress/?task_id=${currentTaskId}`);
          const progress = await response.json();

          updateProgress(progress.progress, progress.message);

          if (progress.status === 'done') {
            clearInterval(pollInterval);
            enableChat();
            showNotification('Document processing complete! You can now ask questions.', 'success');
            resetUploadUI();
          } else if (progress.status === 'error') {
            clearInterval(pollInterval);
            showNotification(`Processing failed: ${progress.message}`, 'error');
            resetUploadUI();
          }
        } catch (error) {
          console.error('Progress polling error:', error);
          clearInterval(pollInterval);
          resetUploadUI();
        }
      }, 2000);
    }

    function updateProgress(percentage, message) {
      progressBar.style.width = `${percentage}%`;
      uploadStatus.textContent = message;
    }

    function resetUploadUI() {
      isUploading = false;
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'üöÄ Process Document';
      progressBarContainer.classList.add('hidden');
    }

    function enableChat() {
      userQuestion.disabled = false;
      askBtn.disabled = false;
      regulatorySummaryBtn.disabled = false;
      suggestedQuestions.classList.remove('hidden');
      userQuestion.placeholder = 'Ask about compliance, risks, key clauses...';

      document.getElementById('chatStatus').innerHTML = `
        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
        Ready - Document loaded
      `;
    }

    function updateDocumentInfo(metadata) {
      if (metadata) {
        docTitle.textContent = metadata.title || 'Untitled Document';
        topMetrics.textContent = `${metadata.pages} pages ‚Ä¢ ${metadata.word_count} words ‚Ä¢ ${(metadata.file_size / 1024 / 1024).toFixed(1)}MB`;
      }
    }

    // Chat functionality
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        askQuestion();
      }
    }

    async function askQuestion() {
      const question = userQuestion.value.trim();

      if (!question) {
        showNotification('Please enter a question.', 'error');
        return;
      }

      if (isProcessing) return;

      isProcessing = true;
      askBtn.disabled = true;

      // Add user message
      addMessage(question, 'user');
      userQuestion.value = '';

      // Add loading message
      const loadingId = addMessage('', 'bot', true);

      try {
        const formData = new FormData();
        formData.append('question', question);

        const response = await fetch('/ask-question/', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        // Remove loading message
        document.getElementById(loadingId).remove();

        if (response.ok) {
          addMessage(result.answer, 'bot', false, result.references);
        } else {
          throw new Error(result.error || 'Failed to get answer');
        }

      } catch (error) {
        console.error('Question error:', error);
        document.getElementById(loadingId).remove();
        addMessage(`Sorry, I encountered an error: ${error.message}`, 'bot');
        showNotification(`Error: ${error.message}`, 'error');
      } finally {
        isProcessing = false;
        askBtn.disabled = false;
      }
    }

    function askSuggested(question) {
      userQuestion.value = question;
      askQuestion();
    }

    function addMessage(content, sender, isLoading = false, references = []) {
      const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      const messageDiv = document.createElement('div');
      messageDiv.id = messageId;
      messageDiv.className = `message-${sender} p-4 max-w-[85%] ${sender === 'user' ? 'ml-auto' : ''}`;

      if (isLoading) {
        messageDiv.className += ' message-loading';
        messageDiv.innerHTML = `
          <div class="mb-2">
            <strong>üß† Lawgic AI</strong>
            <span class="text-xs opacity-70 ml-2">Analyzing...</span>
          </div>
          <div class="typing-indicator">Thinking</div>
        `;
      } else {
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const senderName = sender === 'user' ? 'You' : 'üß† Lawgic AI';

        messageDiv.innerHTML = `
          <div class="mb-2">
            <strong>${senderName}</strong>
            <span class="text-xs opacity-70 ml-2">${timestamp}</span>
          </div>
          <div class="message-content">${formatMessage(content)}</div>
          ${references && references.length > 0 ? formatReferences(references) : ''}
        `;
      }

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      return messageId;
    }

    function formatMessage(content) {
      if (!content) return '';

      // Convert markdown-style formatting to HTML
      return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/^(.*)$/, '<p>$1</p>')
        .replace(/<p><\/p>/g, '');
    }

    function formatReferences(references) {
      if (!references || references.length === 0) return '';

      let referencesHtml = '<div class="mt-3 pt-3 border-t border-opacity-20 border-current"><div class="text-xs opacity-70 mb-2">References:</div><div class="space-y-2">';

      references.forEach((ref, index) => {
        referencesHtml += `
          <div class="text-xs bg-black bg-opacity-10 rounded-lg p-2">
            <div class="flex justify-between items-center mb-1">
              <span class="reference-chip">Page ${ref.page}</span>
              ${ref.relevance ? `<span class="text-xs opacity-70">${ref.relevance}</span>` : ''}
            </div>
            <div class="opacity-80">"${ref.snippet}"</div>
          </div>
        `;
      });

      referencesHtml += '</div></div>';
      return referencesHtml;
    }

    async function generateRegulatorySummary() {
      if (isProcessing) return;

      isProcessing = true;
      regulatorySummaryBtn.disabled = true;
      regulatorySummaryBtn.textContent = '‚è≥ Generating...';

      // Add loading message
      const loadingId = addMessage('', 'bot', true);

      try {
        const response = await fetch('/regulatory-summary/', {
          method: 'POST'
        });

        const result = await response.json();

        // Remove loading message
        document.getElementById(loadingId).remove();

        if (response.ok) {
          addMessage(`üìã **Regulatory Compliance Summary**\n\n${result.answer}`, 'bot', false, result.references);
        } else {
          throw new Error(result.error || 'Failed to generate summary');
        }

      } catch (error) {
        console.error('Summary error:', error);
        document.getElementById(loadingId).remove();
        addMessage(`Sorry, I couldn't generate the regulatory summary: ${error.message}`, 'bot');
        showNotification(`Error: ${error.message}`, 'error');
      } finally {
        isProcessing = false;
        regulatorySummaryBtn.disabled = false;
        regulatorySummaryBtn.textContent = 'üìã Regulatory Summary';
      }
    }

    function clearChat() {
      // Keep only the initial welcome message
      const messages = chatMessages.querySelectorAll('.message-user, .message-bot:not(:first-child)');
      messages.forEach(msg => msg.remove());

      showNotification('Chat cleared successfully.', 'success');
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full opacity-0`;

      // Set colors based on type
      switch (type) {
        case 'success':
          notification.className += ' bg-green-500 text-white';
          break;
        case 'error':
          notification.className += ' bg-red-500 text-white';
          break;
        case 'warning':
          notification.className += ' bg-yellow-500 text-black';
          break;
        default:
          notification.className += ' bg-blue-500 text-white';
      }

      notification.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-sm font-medium">${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.classList.remove('translate-x-full', 'opacity-0');
      }, 100);

      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.classList.add('translate-x-full', 'opacity-0');
          setTimeout(() => {
            if (notification.parentElement) {
              notification.remove();
            }
          }, 300);
        }
      }, 5000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
      // Add welcome message animation
      setTimeout(() => {
        const welcomeMessage = chatMessages.querySelector('.message-bot');
        if (welcomeMessage) {
          welcomeMessage.style.opacity = '0';
          welcomeMessage.style.transform = 'translateY(20px)';
          setTimeout(() => {
            welcomeMessage.style.transition = 'all 0.5s ease';
            welcomeMessage.style.opacity = '1';
            welcomeMessage.style.transform = 'translateY(0)';
          }, 200);
        }
      }, 500);

      // Focus on question input when document is ready
      userQuestion.addEventListener('focus', () => {
        if (userQuestion.disabled) {
          showNotification('Please upload and process a document first.', 'warning');
          userQuestion.blur();
        }
      });

      // Add keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + Enter to ask question
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          if (!userQuestion.disabled) {
            askQuestion();
          }
        }

        // Escape to close mobile menu
        if (e.key === 'Escape') {
          if (sidebar.classList.contains('open')) {
            toggleMobileMenu();
          }
        }
      });

      console.log('üöÄ Lawgic AI Legal Document Analyzer initialized');
    });

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentTaskId) {
        // Refresh status when page becomes visible
        fetch(`/progress/?task_id=${currentTaskId}`)
          .then(response => response.json())
          .then(progress => {
            if (progress.status === 'done' && userQuestion.disabled) {
              enableChat();
            }
          })
          .catch(console.error);
      }
    });

    // Service worker registration for offline support (optional)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Uncomment if you want to add service worker support
        // navigator.serviceWorker.register('/sw.js')
        //   .then(registration => console.log('SW registered'))
        //   .catch(error => console.log('SW registration failed'));
      });
    }

    // Error handling for uncaught errors
    window.addEventListener('error', (e) => {
      console.error('Global error:', e.error);
      showNotification('An unexpected error occurred. Please refresh the page.', 'error');
    });

    window.addEventListener('unhandledrejection', (e) => {
      console.error('Unhandled promise rejection:', e.reason);
      showNotification('A network error occurred. Please check your connection.', 'error');
    });
  </script>
</body>

</html>